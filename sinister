#!/bin/sh

set -e

help()
{
    echo 'sinister is a simple installer for shell scripts.'
    echo
    echo 'Usage: sinister [-l|--local] [-n|--name name] [-o|--output dir] [-u|--url url]'
    echo
    echo 'Options:'
    echo
    echo 'local: Specifies the script should be saved for the current user instead of the entire machine.'
    echo
    echo 'name: The name of the file the script should be saved to. Mandatory if no URL is given.'
    echo
    echo 'url: The location of the script online. e.g: https://github.com/you/repo/raw/master/script'
    echo 'If no URL is given the script is read from stdin.'
    echo
    echo 'output: The output directory the script should be saved to.'
    echo 'By default this is ~/bin on Unix systems, and C:\Users\you\AppData\Local\script on Windows.'
}

on_windows()
{
    uname | grep -q '[CYGWIN|MINGW|MSYS]'
}

run_powershell()
{
    powershell -NoProfile -ExecutionPolicy Bypass "$1"
}

getpath_windows()
{
    run_powershell "[Environment]::GetEnvironmentVariable('PATH', '$1')"
}

setpath_windows()
{
    run_powershell "[Environment]::SetEnvironmentVariable('PATH', '$1', '$2')"
}

pwd_windows()
{
    run_powershell "Get-Location"
}

DEBUG='false'
LOCAL='false'
NAME=''
URL=''

test $# -ne 0
while [ $# -gt 0 ]
do
    case "$1" in
        '-?'|-h|--help) help; exit 0 ;;
        -d|--debug) DEBUG='true'
        -l|--local) LOCAL='true' ;;
        -n|--name) NAME="$2"; shift ;;
        -o|--output) OUTPUT="$2"; shift ;;
        -u|--url) URL="$2"; shift ;;
        *) help; exit 1 ;;
    esac
    shift
done

if [ $DEBUG = 'true' ]; then
    set -x
fi

if [ -z "$OUTPUT" ]; then
    if [ $LOCAL = 'true' ]; then
        if on_windows; then
            OUTPUT='~/AppData/Local'
        else
            OUTPUT='~/bin'
        fi
    else
        if on_windows; then
            OUTPUT='/C/Program Files'
        else
            OUTPUT='/usr/local/bin'
        fi
    fi
fi

if [ -z "$URL" ]; then
    test ! -z "$NAME"
    SCRIPT=$(< /dev/stdin) # read from standard input
else
    NAME=${URL##*/} # Grab everything after the last /
    if which curl > /dev/null 2>&1; then
        SCRIPT=$(curl -sSL "$URL")
    else # Assume wget is installed
        SCRIPT=$(wget -q -O - "$URL")
    fi
fi

# Where the magic happens
cd "$OUTPUT"
echo "$SCRIPT" > "$NAME"
chmod +x "$NAME"

# Add $OUTPUT to PATH if it's not in it
if ! which "$NAME" > /dev/null 2>&1; then
    if on_windows; then
        if [ $LOCAL = 'true' ]; then
            TARGET='User'
        else
            TARGET='Machine'
        fi
        CURRENT_PATH=$(getpath_windows $TARGET)
        CURRENT_DIRECTORY=$(pwd_windows)
        setpath_windows "$CURRENT_PATH;$CURRENT_DIRECTORY" $TARGET
    else # Unix
        CONTENTS="export PATH=\$PATH:$OUTPUT"
        if [ $LOCAL = 'true' ]; then
            echo "$CONTENTS" >> ~/.profile
        else
            echo "$CONTENTS" >> /etc/profile
        fi
    fi
fi
